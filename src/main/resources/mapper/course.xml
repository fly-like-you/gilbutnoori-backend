<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.gilbut.domain.course.mapper.CourseMapper">
    <!-- ResultMap 정의 -->
    <resultMap id="CourseRouteResultMap" type="CourseDetailResponseDTO">
        <!-- Course 필드 매핑 -->
        <id property="id" column="course_id"/>
        <result property="name" column="course_name"/>
        <result property="dist" column="dist"/>
        <result property="turnaround" column="turnaround"/>
        <result property="level" column="level"/>
        <result property="cycle" column="cycle"/>
        <result property="summary" column="summary"/>
        <result property="detail" column="detail"/>
        <result property="travelPoint" column="travel_point"/>
        <result property="travelerInfo" column="traveler_info"/>
        <result property="sigun" column="sigun"/>
        <result property="roadOrBike" column="road_or_bike"/>
        <result property="createdAt" column="course_created_at"/>
        <result property="updatedAt" column="course_updated_at"/>

        <association property="route" column="route_id" javaType="RouteDTO" resultMap="route"/>

    </resultMap>
    <!-- Route 필드 매핑 -->
    <resultMap id="route" type="RouteDTO">
        <id property="id" column="route_id"/>
        <result property="name" column="route_name"/>
        <result property="summary" column="route_summary"/>
        <result property="detail" column="route_detail"/>
        <result property="roadOrBike" column="route_road_or_bike"/>
        <result property="createdAt" column="route_created_at"/>
        <result property="updatedAt" column="route_updated_at"/>
    </resultMap>

    <!-- 쿼리 시작 -->
    <select id="courseList" resultType="CourseDetailResponseDTO">
        select c.id,
        c.route_id,
        c.name,
        c.dist,
        c.turnaround,
        c.level,
        c.cycle,
        c.summary,
        c.detail,
        c.travel_point,
        c.traveler_info,
        c.sigun,
        c.created_at,
        c.updated_at,
        c.road_or_bike
        from courses c
        <include refid="pagination"/>

    </select>

    <select id="courseDetail" resultMap="CourseRouteResultMap">
        SELECT c.id           AS course_id,
               c.name         AS course_name,
               c.dist,
               c.turnaround,
               c.level,
               c.cycle,
               c.summary,
               c.detail,
               c.travel_point,
               c.traveler_info,
               c.sigun,
               c.road_or_bike,
               c.created_at   AS course_created_at,
               c.updated_at   AS course_updated_at,
               r.id           AS route_id,
               r.name         AS route_name,
               r.summary      AS route_summary,
               r.detail       AS route_detail,
               r.road_or_bike AS route_road_or_bike,
               r.created_at   AS route_created_at,
               r.updated_at   AS route_updated_at
        FROM Courses c
                 JOIN Routes r
                      ON c.route_id = r.id
        WHERE c.id = #{courseId}

    </select>

    <select id="routeList">
        SELECT id, name, summary, detail, road_or_bike, created_at, updated_at
        FROM Routes LIMIT ${pageable.offset}, ${pageable.pageSize}
    </select>
    <select id="countCourses" resultType="int">
        SELECT COUNT(*) AS course_count
        FROM courses
    </select>
    <select id="countRoutes" resultType="int">
        SELECT COUNT(*) AS route_count
        FROM Routes
    </select>
    <select id="countCoursesBy" resultType="int">
        SELECT COUNT(*)
        FROM Courses
        WHERE 1 = 1
        <include refid="searchConditions"></include>
    </select>

    <select id="courseSearchBy">
        SELECT
        c.id,
        c.route_id,
        c.name,
        c.dist,
        c.turnaround,
        c.level,
        c.cycle,
        c.summary,
        c.detail,
        c.travel_point,
        c.traveler_info,
        c.sigun,
        c.created_at,
        c.updated_at,
        c.road_or_bike
        FROM Courses c
        WHERE 1=1
        <include refid="searchConditions"/>
        <include refid="pagination"/>

    </select>

    <!-- 페이지네이션 -->
    <sql id="pagination">
        <if test="pageable.sort.sorted">
            <trim prefix="ORDER BY">
                <foreach item="order" collection="pageable.sort" separator=", ">
                    ${order.property} ${order.direction}
                </foreach>
            </trim>
        </if>
        LIMIT #{pageable.offset}, #{pageable.pageSize}
    </sql>

    <!-- 공통 WHERE 조건 -->
    <sql id="searchConditions">
        <if test="criteria.routeId != null">
            AND route_id = #{criteria.routeId}
        </if>
        <if test="criteria.dist != null">
            AND dist = #{criteria.dist}
        </if>
        <if test="criteria.turnaround != null">
            AND turnaround = #{criteria.turnaround}
        </if>
        <if test="criteria.level != null">
            AND level = #{criteria.level}
        </if>
        <if test="criteria.cycle != null">
            AND cycle = #{criteria.cycle}
        </if>
        <if test="criteria.sidoCode != null">
            AND sido_code = #{criteria.sidoCode}
        </if>
    </sql>

</mapper>